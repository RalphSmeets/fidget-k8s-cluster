#cloud-config
hostname: ${hostname}
ssh_authorized_keys:
%{ for ssh_key in ssh_keys ~}
  - ${ssh_key}
%{ endfor ~}
write_files:
  - content: |
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
    path: /etc/sysctl.d/k8s.conf
  - content: |
      deb https://apt.kubernetes.io/ kubernetes-xenial main
    path: /etc/apt/sources.list.d/kubernetes.list
  - content: |
      iface eth0 inet static 
        address ${hostip} 
        broadcast 192.168.1.255
        netmask 255.255.255.0 
        gateway 192.168.1.1
        dns-nameservers 192.168.1.1
    path: /etc/network/interfaces.d/99-kubernetes.cfg
package_upgrade: true
packages:
  - curl
  - gnupg2
runcmd:
  - update-alternatives --set iptables /usr/sbin/iptables-legacy
  - sysctl --system
  - sed -i 's/^iface eth0 inet dhcp//' /etc/network/interfaces
  - rm -f /etc/network/interfaces.d/50-cloud-init.cfg 
  - systemctl restart networking
  - hostnamectl set-hostname "${hostname}" 
  - echo "127.0.0.1 ${hostname}" >> /etc/hosts
%{ for vm in machines ~} 
  - echo "${vm.hostip} ${vm.hostname}" >> /etc/hosts
%{ endfor ~}
  - curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
  - reboot
